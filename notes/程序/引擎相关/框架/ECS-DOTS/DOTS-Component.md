# 1. Componentæ¦‚è¿°

## æ‰€æœ‰ç»„ä»¶ç±»å‹

| æ¥å£                   | è¯´æ˜                           | å…¸å‹ç”¨é€”                       | ä¼˜ç‚¹               | ç¼ºç‚¹                   | æ˜¯å¦æ”¯æŒå¹¶è¡Œ Job  |
| ---------------------- | ------------------------------ | ------------------------------ | ------------------ | ---------------------- | ----------------- |
| `IComponentData`       | æ™®é€šæ•°æ®ç»„ä»¶ï¼ˆæœ€å¸¸ç”¨ï¼‰         | ä½ç½®ã€é€Ÿåº¦ã€ç”Ÿå‘½ç­‰             | æ€§èƒ½é«˜ï¼Œçµæ´»       | éœ€è¦åŒ¹é…ç±»å‹ç»„åˆæ¥åˆ†ç»„ | âœ…                 |
| `IBufferElementData`   | å¯å˜é•¿çš„ç»„ä»¶æ•°ç»„               | èƒŒåŒ…ã€è·¯å¾„ç‚¹ã€æŠ€èƒ½æ§½           | è¡¨ç¤ºåˆ—è¡¨æ•°æ®       | ç¼–ç¨‹ç¨å¤æ‚             | âœ…ï¼ˆæ³¨æ„ç‰¹æ®Šè°ƒåº¦ï¼‰ |
| `ISharedComponentData` | è·¨ Chunk çš„å…±äº«ç»„ä»¶            | æè´¨ã€åŠ¨ç”»ç±»å‹ç­‰               | åˆ†ç»„æ¸²æŸ“ã€åˆ†ç»„è®¡ç®— | ä¸èƒ½ Jobã€æ…¢           | âŒï¼ˆä¸èƒ½å¹¶è¡Œï¼‰     |
| `IEnableableComponent` | å¯å¯ç”¨/ç¦ç”¨ç»„ä»¶ï¼Œè€Œéæ·»åŠ /ç§»é™¤ | åŠ¨æ€åˆ‡æ¢é€»è¾‘åˆ†æ”¯ï¼ˆå¦‚ AI å¯ç”¨ï¼‰ | å¿«é€Ÿåˆ‡æ¢çŠ¶æ€       | å ç©ºé—´ï¼Œä¸å¦‚ç§»é™¤å½»åº•   | âœ…                 |
| `IComponentData + Tag` | ç©ºç»„ä»¶ï¼Œç”¨äºæ ‡è®°ï¼ˆæ— å­—æ®µï¼‰     | æ ‡è®°â€œæ•Œäººâ€ã€â€œéœ€è¦å¤„ç†â€ç­‰       |                    |                        | âœ…                 |

## ç»„ä»¶å¿…é¡»æ˜¯ç»“æ„ä½“

æ•°æ®ç»„ä»¶å¿…é¡»æ˜¯ç»“æ„ä½“ï¼ˆ`struct`ï¼‰ï¼Œæ‰€æœ‰é€»è¾‘æ•°æ®éƒ½åº”ä»¥ç»„ä»¶å½¢å¼é™„åŠ åœ¨ Entity ä¸Šã€‚

**ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ structï¼Ÿ**
ECS å¼ºè°ƒæ•°æ®æ€§èƒ½ï¼š

- **struct æ˜¯å€¼ç±»å‹**
  - å¯è¿ç»­å†…å­˜æ’åˆ—ï¼ˆcache-friendlyï¼‰
  - æ— å †åˆ†é…
  - æ—  GCã€‚

- å¼•ç”¨ç±»å‹ï¼ˆclassï¼‰åˆ™ä¼šå¸¦æ¥ï¼š
  - å†…å­˜ç¢ç‰‡åŒ–
  - å †åˆ†é…ã€GC å‹åŠ›
  - ç ´åçº¿ç¨‹å®‰å…¨

æ‰€ä»¥ **æ‰€æœ‰ Component å¿…é¡»æ˜¯ structï¼Œä¸”å¿…é¡»æ˜¯ blittableï¼ˆå¯è¢« Burst ç¼–è¯‘ï¼‰**

## blittable struct

Blittableï¼ˆå¯å¹³ç§»ï¼‰struct æ˜¯ä¸€ç§å¯ä»¥ç›´æ¥åœ¨å†…å­˜ä¸­â€œæŒ‰å­—èŠ‚å¤åˆ¶â€çš„ç»“æ„ä½“ã€‚

æ¢å¥è¯è¯´ï¼š
å®ƒåœ¨æ‰˜ç®¡ï¼ˆC#ï¼‰å’Œéæ‰˜ç®¡ï¼ˆåŸç”Ÿï¼‰å†…å­˜ä¸­çš„å¸ƒå±€æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œ**å¯ä»¥å®‰å…¨åœ°ç›´æ¥æ‹·è´åˆ° Native å†…å­˜ä¸­ã€ä¼ é€’ç»™ Jobã€Burstã€Unsafe ä»£ç ä½¿ç”¨**ã€‚

ä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­

```c#
public struct MyData{
    public float Value;
    public int ID;
}
```

è¿™ä¸ªç»“æ„ä½“åªåŒ…å«åŸºæœ¬å€¼ç±»å‹ï¼ˆfloatã€intï¼‰ï¼Œå®ƒå°±æ˜¯ **blittable çš„**ï¼Œå¯ä»¥ç›´æ¥ä¼ å…¥ DOTS çš„ä¸–ç•Œã€‚

é blittable çš„ä¾‹å­ï¼š

```c#
public struct BadData{
    public string Name;             // âŒ å¼•ç”¨ç±»å‹
    public UnityEngine.GameObject GO; // âŒ Unity å¼•ç”¨ç±»å‹
}
```

è¿™äº›ç±»å‹åœ¨å†…å­˜ä¸­ä¸æ˜¯â€œå›ºå®šç»“æ„â€ï¼Œéœ€è¦ GC ç®¡ç†ã€åŒ…å«å¼•ç”¨å¤´ç­‰ä¿¡æ¯ï¼Œ**ä¸å…è®¸ç”¨äº DOTS çš„ç»„ä»¶ã€Bufferã€Job æ•°æ®ä¸­**ã€‚

**ä¸ºä»€ä¹ˆè¦ blittableï¼Ÿ**

Unity DOTS è¦å®ç°ï¼š

- Job å¹¶è¡Œï¼ˆå¤šçº¿ç¨‹ï¼‰
- Burst ç¼–è¯‘ï¼ˆC# â†’ é«˜æ•ˆ Native æ±‡ç¼–ï¼‰
- NativeArray / Chunk æ•°æ®å¯¹é½
- Unsafe æ“ä½œï¼ˆæ²¡æœ‰ GCï¼‰

è¿™éƒ½è¦æ±‚ä½ ç”¨çš„æ•°æ®å¿…é¡»æ˜¯ **â€œåŸç”Ÿç»“æ„â€**ï¼Œèƒ½è¢«**ä½æ‹·è´ï¼ˆmemcpyï¼‰**ã€**å›ºå®šå¸ƒå±€ï¼ˆlayout sequentialï¼‰**çš„ç±»å‹ â€”â€” ä¹Ÿå°±æ˜¯ **blittable struct**ã€‚

**Blittable ç±»å‹çš„åˆ¤æ–­è§„åˆ™ï¼ˆä½ åªéœ€è®°ä½ä¸‹é¢è¿™äº›ï¼‰**

| ç±»å‹                                    | æ˜¯å¦ blittable | å¤‡æ³¨                       |
| --------------------------------------- | -------------- | -------------------------- |
| `int`, `float`, `bool`, `byte`, `char`  | âœ… æ˜¯           | åŸºæœ¬å€¼ç±»å‹å…¨éƒ¨ OK          |
| `fixed` æ•°ç»„ï¼ˆunsafe contextï¼‰          | âœ… æ˜¯           | å¦‚ `fixed int ids[4]`      |
| `Unity.Mathematics.float3`ã€`int2`      | âœ… æ˜¯           | DOTS æ•°å­¦åº“å®Œå…¨ blittable  |
| åŒ…å«ä»¥ä¸Šç±»å‹å­—æ®µçš„ `struct`             | âœ… æ˜¯           | åªè¦ä¸å«å¼•ç”¨ï¼Œå°± OK        |
| `string`                                | âŒ å¦           | æ‰€æœ‰å¼•ç”¨ç±»å‹éƒ½ä¸è¡Œ         |
| `object`, `GameObject`, `MonoBehaviour` | âŒ å¦           | Unity çš„ç®¡ç†å¯¹è±¡éƒ½ä¸è¡Œ     |
| åŒ…å«ä¸Šè¿°å¼•ç”¨ç±»å‹å­—æ®µçš„ struct           | âŒ å¦           | å“ªæ€•ä¸€ä¸ªå­—æ®µå¼•ç”¨ç±»å‹éƒ½ä¸è¡Œ |

å¦‚ä½•ç”¨ä»£ç ç¡®è®¤ä¸€ä¸ªç±»å‹æ˜¯å¦ blittableï¼Ÿ

 `Unity.Collections.LowLevel.Unsafe.UnsafeUtility.IsBlittable<T>()` æ¥éªŒè¯ï¼š

```c#
Debug.Log(UnsafeUtility.IsBlittable<MyStruct>());  // è¾“å‡º true / false
```

> `[BurstCompile]` ä¹Ÿè¦æ±‚å‚æ•° blittableï¼
> æ‰€ä»¥ä½  Job ä¸­çš„æ•°æ®ç»“æ„å¦‚æœä¸ blittableï¼Œ**Burst ç¼–è¯‘ä¼šæŠ¥é”™**ï¼Œæˆ–è€…ä½ ä¼šè¢«é™åˆ¶ä½¿ç”¨ Burstã€‚

# 2. IComponentData

```c#
public struct MoveSpeed : IComponentData{
    public float Value;
}
```



 # 3. `IBufferElementData`

IBufferElementDataæ˜¯Unity DOTS ä¸­çš„â€œåŠ¨æ€æ•°ç»„ç»„ä»¶â€ï¼Œå®ƒå…è®¸ä½ ç»™æ¯ä¸ª Entity æŒ‚ä¸Šä¸€ä¸ªå˜é•¿çš„æ•°æ®åˆ—è¡¨ã€‚

ç±»æ¯”ï¼š

```c#
// æ™®é€šç»„ä»¶ï¼ˆå€¼ç±»å‹ï¼‰
public struct Health : IComponentData{
    public float Value;
}

// Buffer ç»„ä»¶ï¼ˆåŠ¨æ€åˆ—è¡¨ï¼‰
public struct InventoryItem : IBufferElementData{
    public int ItemID;
}
```

æŒ‚è½½åï¼Œæ¯ä¸ª Entity å¯ä»¥æ‹¥æœ‰ä¸€ä¸ª `DynamicBuffer<InventoryItem>`ï¼Œåƒè¿™æ ·ä½¿ç”¨ï¼š

```c#
DynamicBuffer<InventoryItem> buffer = EntityManager.GetBuffer<InventoryItem>(entity);
buffer.Add(new InventoryItem { ItemID = 42 });
```

**å’Œæ™®é€šç»„ä»¶æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

| ç‰¹æ€§                   | æ™®é€šç»„ä»¶ `IComponentData` | Buffer ç»„ä»¶ `IBufferElementData` |
| ---------------------- | ------------------------- | -------------------------------- |
| æ˜¯å¦å•ä¸ªå€¼             | âœ… æ˜¯                      | âŒ ä¸æ˜¯ï¼ˆæ˜¯æ•°ç»„ï¼‰                 |
| æ˜¯å¦å›ºå®šå¤§å°           | âœ… å›ºå®šç»“æ„ä½“              | âŒ å¯å˜é•¿åº¦                       |
| æ˜¯å¦æŒ‰åˆ—å­˜åœ¨ Chunk     | âœ… æ˜¯                      | âœ… æ˜¯ï¼Œä½†æ¯è¡ŒæŒ‡å‘ç‹¬ç«‹ Buffer åŒºåŸŸ |
| æ¯ä¸ª Entity éƒ½å¿…é¡»æœ‰å— | âŒ å¯é€‰                    | âŒ å¯é€‰                           |
| å¦‚ä½•è®¿é—®               | é€šè¿‡ `ref`                | é€šè¿‡ `DynamicBuffer<T>`          |

## å­˜å‚¨åŸç†

æ¯ä¸ªæ‹¥æœ‰ Buffer çš„ Entity åœ¨å…¶æ‰€å± Chunk ä¸­ï¼š

- ä¼šåœ¨ Chunk ä¸­æ³¨å†Œä¸€åˆ— `BufferHeader[]`
- æ¯ä¸€è¡Œå¯¹åº”ä¸€ä¸ª Entity çš„ Buffer å®ä½“
- åˆå§‹ç©ºé—´é€šå¸¸å­˜åœ¨ Chunk å°¾éƒ¨ï¼ˆInlineï¼‰ï¼Œå¯ç”¨ç©ºé—´è€—å°½åè‡ªåŠ¨æº¢å‡ºåˆ° Heap

 Chunk ä¸­å®é™…ç»“æ„å¦‚ä¸‹ï¼š

```
Chunk
â”œâ”€â”€ ComponentA[]
â”œâ”€â”€ ComponentB[]
â”œâ”€â”€ BufferHeader[InventoryItem]
â”‚    â”œâ”€â”€ Entity 1: [ItemID 12, 44, 76]
â”‚    â”œâ”€â”€ Entity 2: []
â”‚    â”œâ”€â”€ Entity 3: [ItemID 99]
â”‚    ...
```

**Buffer æ˜¯ä»€ä¹ˆï¼Ÿ**
Buffer å°±æ˜¯â€œEntity ç§æœ‰çš„åŠ¨æ€åˆ—è¡¨â€ï¼Œç”± Chunk æä¾›é¦–éƒ¨ç®¡ç†ï¼Œæ•°æ®å¯èƒ½å­˜åœ¨ Chunk æˆ– Heapã€‚

ç»“æ„ç±»ä¼¼äºï¼š

```
DynamicBuffer<T>
â”œâ”€â”€ Pointer to actual memory
â”œâ”€â”€ Length
â”œâ”€â”€ Capacity
```

å®ƒä¸ç­‰äº `List<T>`ï¼Œä½†å¯ä»¥ç±»æ¯”ç†è§£ä¸º C++ çš„ small buffer optimizationã€‚

## ä½¿ç”¨æ–¹æ³•

**å¦‚ä½•åˆ›å»º Bufferï¼Ÿ**

ä½ å¿…é¡»ç»™å®ƒæ ‡æ³¨ `[InternalBufferCapacity(x)]`ï¼š

```c#
[InternalBufferCapacity(8)]
public struct InventoryItem : IBufferElementData{
    public int ItemID;
}
```

è¿™ä¸ªå®¹é‡å®šä¹‰äº†åˆå§‹ Chunk Inline å­˜å‚¨ç©ºé—´å¤§å°ï¼Œè¶…è¿‡åä¼šåˆ†é… heapã€‚

**å¦‚ä½•è¯»å†™ Bufferï¼Ÿ**

**åœ¨ System ä¸­ä½¿ç”¨ï¼š**

```c#
Entities
  .ForEach((Entity entity, ref Translation t, DynamicBuffer<InventoryItem> buffer) =>{
    buffer.Add(new InventoryItem { ItemID = 10 });
    var id = buffer[0].ItemID;
}).Schedule();
```

**åœ¨éç³»ç»Ÿä»£ç ä¸­ä½¿ç”¨ï¼š**

```c#
var buffer = EntityManager.GetBuffer<InventoryItem>(entity);
buffer.Clear();
buffer.Add(new InventoryItem { ItemID = 1 });
```

**âš ï¸ æ³¨æ„äº‹é¡¹**

| é¡¹ç›®                              | å»ºè®®                               |
| --------------------------------- | ---------------------------------- |
| ä½¿ç”¨å‰å¿…é¡» AddBuffer<T>()         | å¦åˆ™ä½ ä¼šå–ä¸åˆ°æ•°æ®                 |
| ä¸æ”¯æŒå¤æ‚å¼•ç”¨ç±»å‹                | Buffer å…ƒç´ å¿…é¡»æ˜¯ blittable struct |
| ä¸å»ºè®®é¢‘ç¹ Add/Remove è¶…å‡º Inline | å®¹æ˜“è§¦å‘ heap åˆ†é…ï¼Œå½±å“æ€§èƒ½       |
| ä¸æ”¯æŒ IJobParallelFor ç­‰å¹¶è¡Œå†™å…¥ | å¤šçº¿ç¨‹è¦å°å¿ƒï¼                     |

**ğŸ’¡ å…¸å‹åº”ç”¨åœºæ™¯ï¼š**

| ç”¨æ³•               | ä¸¾ä¾‹                                    |
| ------------------ | --------------------------------------- |
| å•ä½èƒŒåŒ…ç³»ç»Ÿ       | InventoryBuffer: List<itemId>           |
| æ•Œäººè·¯å¾„ç³»ç»Ÿ       | WaypointBuffer: List<float3>            |
| è¿æ‹›ã€æŠ€èƒ½æ’­æ”¾è½¨è¿¹ | ActionBuffer: List<Command>             |
| ç½‘ç»œåŒæ­¥å†å²å¸§     | InputHistoryBuffer: List<InputSnapshot> |

# 4. `ISharedComponentData`

Shared Component æ˜¯ä¸€ç§ **â€œå€¼ç›¸åŒè€…å…±äº«ã€Chunk åˆ†ç»„ä¾æ®â€** çš„ç‰¹æ®Šç»„ä»¶ã€‚
å®ƒä¸æ˜¯ç”¨æ¥åšæ•°æ®æ›´æ–°çš„ï¼Œè€Œæ˜¯ç”¨æ¥**åˆ†ç»„å®ä½“ï¼Œè®©å®ƒä»¬è¢«æ”¾è¿›ä¸åŒ Chunk çš„ä¾æ®ä¹‹ä¸€**ã€‚
å¯ä»¥ç†è§£ä¸ºæ˜¯ ECS çš„â€œé€»è¾‘æ ‡ç­¾ + Chunk åˆ†ç»„é”®â€

**ä¸¾ä¸ªä¾‹å­ï¼š**

```c#
public struct Team : ISharedComponentData{
    public int TeamID;
}
```

å¦‚æœä½ ç»™ 1000 ä¸ªå®ä½“åˆ†åˆ«èµ‹å€¼ TeamID = 0~9ï¼Œé‚£ ECS ä¼šæŠŠå®ƒä»¬æ”¾å…¥ 10 ä¸ªä¸åŒçš„ Chunkï¼š

```
[Chunk1] â†’ TeamID = 0 â†’ 100ä¸ª Entity
[Chunk2] â†’ TeamID = 1 â†’ 100ä¸ª Entity
...
[Chunk10] â†’ TeamID = 9 â†’ 100ä¸ª Entity
```

æ‰€ä»¥ï¼š**Shared Component æ§åˆ¶ Chunk çš„â€œæ¨ªå‘åˆ†åŒºâ€ï¼Œæ¯ä¸ªå€¼å”¯ä¸€çš„ Shared Component éƒ½ä¼šå¯¼è‡´æ–°çš„ Archetype + Chunk äº§ç”Ÿ**

**å®ƒå’Œæ™®é€šç»„ä»¶çš„åŒºåˆ«æ˜¯ï¼Ÿ**

| ç‰¹æ€§                     | `IComponentData` | `ISharedComponentData`                   |
| ------------------------ | ---------------- | ---------------------------------------- |
| æ˜¯å¦å†…è”å­˜å‚¨åœ¨ Chunk ä¸­  | âœ… æ˜¯             | âŒ ä¸æ˜¯                                   |
| æ‰€æœ‰ Entity æ‹¥æœ‰ç‹¬ç«‹å‰¯æœ¬ | âœ… æ˜¯             | âŒ å€¼ç›¸åŒå®ä½“å…±äº«ä¸€ä»½                     |
| æ˜¯å¦å¯é¢‘ç¹ä¿®æ”¹           | âœ… å¯ä»¥           | âŒ ä¿®æ”¹ä¼šå¯¼è‡´ç§»åŠ¨ Chunk                   |
| æ˜¯å¦å‚ä¸ Job ä¸­æ›´æ–°      | âœ… æ”¯æŒ           | âŒ ä¸æ”¯æŒï¼ˆåªèƒ½ç”¨äºåˆ†ç»„ï¼‰                 |
| å¯å¦ç”¨äºæŸ¥è¯¢è¿‡æ»¤         | âœ… å¯ä»¥           | âœ… ç‰¹åˆ«é€‚åˆç”¨æ¥ WithSharedComponentFilter |

## å­˜å‚¨åŸç†

å®ƒ **ä¸å­˜åœ¨äº Chunk ä¸­çš„åˆ—ä¸­**ï¼Œè€Œæ˜¯ï¼š

- æ‰€æœ‰å…·æœ‰ç›¸åŒ SharedComponent å€¼çš„å®ä½“ä¼šè¢«æ”¾è¿›ä¸€ä¸ª Chunk
- SharedComponent å®ä¾‹å­˜å‚¨åœ¨ Unity å†…éƒ¨çš„â€œSharedComponentStoreâ€
- Chunk ä»…å¼•ç”¨è¯¥ SharedComponent çš„ç´¢å¼•ï¼ˆç±»ä¼¼æŒ‡é’ˆï¼‰

è¿™æ„å‘³ç€ï¼šæ”¹å˜ä¸€ä¸ªå®ä½“çš„ SharedComponent å€¼ â†’ å®ƒä¼šè¢«ç§»åŠ¨åˆ°å¦ä¸€ä¸ª Chunkï¼

**Chunk ç»“æ„å›¾å¯¹æ¯”ï¼š**

```
æ™®é€šç»„ä»¶ï¼š
Chunk
â”œâ”€â”€ Component A[]
â”œâ”€â”€ Component B[]

å…±äº«ç»„ä»¶ï¼š
Chunk
â”œâ”€â”€ Component A[]
â”œâ”€â”€ SharedComponentIndex: 3  â†’ æŒ‡å‘ TeamID = 3
```

> âš ï¸ ä½†æ³¨æ„,SharedComponent çš„å€¼å‚ä¸ Chunk åˆ†ç»„ï¼Œä½†ä¸ä¼šåˆ›å»ºæ–°çš„ Archetype

**æ¡ˆä¾‹ï¼š**
æˆ‘ä»¬æœ‰ç»„ä»¶å¦‚ä¸‹ï¼š

- æ™®é€šç»„ä»¶ Aã€Bï¼š`IComponentData`
- å…±äº«ç»„ä»¶ Cï¼š`ISharedComponentData`

æˆ‘ä»¬æœ‰ 4 ä¸ªå®ä½“ï¼š

| å®ä½“ | æ‹¥æœ‰ç»„ä»¶ |
| ---- | -------- |
| a    | A, C(1)  |
| b    | A, C(2)  |
| c    | A, C(1)  |
| d    | B        |

è¦æ³¨æ„çš„æ˜¯è¿™ä¸¤ä¸ªæ¦‚å¿µçš„åŒºåˆ«ï¼š

| æ¦‚å¿µ           | å®šä¹‰                                                     | ä¸¾ä¾‹                                            |
| -------------- | -------------------------------------------------------- | ----------------------------------------------- |
| **Archetype**  | ç»„ä»¶ç±»å‹ç»„åˆï¼ˆåªçœ‹æœ‰å“ªäº›ç±»å‹ï¼Œä¸ç®¡å€¼ï¼‰                   | `A + C`ã€`B`                                    |
| **Chunk åˆ†ç»„** | ç›¸åŒ Archetype ä¸‹ï¼Œ**å†æŒ‰ SharedComponent çš„å€¼åˆ† Chunk** | A+C(1)ã€A+C(2) æ˜¯åŒä¸€ä¸ª Archetypeï¼Œä½†ä¸åŒ Chunk |

æœ€ç»ˆçš„Archetypeä¸Chunkç»“æ„ï¼š

```
[Archetype A+C]
  â”œâ”€ Chunk 1 â†’ SharedComponent C = 1 â†’ å­˜ a, c
  â”œâ”€ Chunk 2 â†’ SharedComponent C = 2 â†’ å­˜ b

[Archetype B]
  â””â”€ Chunk 3 â†’ æ²¡æœ‰ SharedComponent â†’ å­˜ d
```

## ä½¿ç”¨æ–¹æ³•

ä½ å¯ä»¥è¿™æ ·ä½¿ç”¨ Shared Component æ¥åˆ†ç»„ï¼š

```c#
Entities
  .WithSharedComponentFilter(new Team { TeamID = 3 })
  .ForEach((ref Translation t) => {
      // åªå¤„ç† TeamID ä¸º 3 çš„å®ä½“
  }).Schedule();
```

**âš ï¸æ³¨æ„äº‹é¡¹ï¼š**

| è§„åˆ™                                         | è¯´æ˜                                             |
| -------------------------------------------- | ------------------------------------------------ |
| â— ä¸é€‚åˆé¢‘ç¹ä¿®æ”¹                             | ä¿®æ”¹ä¼šè§¦å‘å®ä½“è¿ç§»ï¼ˆå½±å“æ€§èƒ½ï¼‰                   |
| âœ… éå¸¸é€‚åˆåš â€œé€»è¾‘åˆ†åŒºâ€ã€â€œæ¸²æŸ“ç»„â€ ç­‰å›ºå®šåˆ†ç±» |                                                  |
| âŒ ä¸æ”¯æŒ Job ä¸­ä¼ å…¥å‚æ•°                      | åªèƒ½ç”¨äº `.WithSharedComponentFilter` è¿‡æ»¤åå¤„ç† |

**å®é™…ä½¿ç”¨åœºæ™¯ï¼š**

| åœºæ™¯                        | ç”¨æ³•                                          |
| --------------------------- | --------------------------------------------- |
| æ¸²æŸ“åˆæ‰¹ï¼ˆHybrid Rendererï¼‰ | æ¯ç§æè´¨ç”¨ä¸€ä¸ª SharedComponentï¼ˆMaterial IDï¼‰ |
| åœ°å›¾åŒºåŸŸåˆ’åˆ†                | æ¯ä¸ªåŒºåŸŸä¸€ä¸ª ZoneIDï¼Œæ–¹ä¾¿ç³»ç»ŸæŒ‰åŒºå—å¤„ç†       |
| é˜µè¥/é˜µè¥ AI è¡Œä¸º           | ä¸åŒ Team ç”¨ä¸åŒ SharedComponent              |
| ç²’å­ç³»ç»Ÿ/åŠ¨ç”»å®ä¾‹åˆ†ç±»       | åŒç±»å‹å½’å…¥åŒä¸€ç»„ï¼Œä¼˜åŒ–æ‰¹å¤„ç†                  |

# 5. Enableable Components

Enableable Component å°±æ˜¯ **å¯ä»¥åœ¨ä¸ç§»é™¤ç»„ä»¶çš„å‰æä¸‹ï¼Œæš‚æ—¶è®©ç»„ä»¶â€œå¤±æ•ˆâ€** çš„ DOTS æ–°èƒ½åŠ›ã€‚

å®ƒæ˜¯ Unity Entities 1.0 å¼•å…¥çš„æœºåˆ¶ï¼Œä½œç”¨æ˜¯ï¼šé¿å…é¢‘ç¹ `AddComponent` / `RemoveComponent` æ‰€å¸¦æ¥çš„ Chunk ç§»åŠ¨å¼€é”€

ä¸¾ä¸ªä¾‹å­ï¼š

```c#
public struct Movement : IComponentData, IEnableableComponent{
    public float Speed;
}
```

ç»™å®ä½“æ·»åŠ  `Movement` åï¼Œå¯ä»¥ï¼š

- å¯ç”¨ï¼šç³»ç»Ÿèƒ½å¤„ç†å®ƒ
- ç¦ç”¨ï¼šç³»ç»Ÿè·³è¿‡å¤„ç†ï¼Œä½†ç»„ä»¶ä»åœ¨å†…å­˜ä¸­ï¼

**ä¸ºä»€ä¹ˆä¸æ˜¯æ‰€æœ‰ç»„ä»¶éƒ½æ˜¯ Enableable çš„ï¼Ÿ**
å› ä¸ºï¼š

- æ™®é€šç»„ä»¶æ²¡æœ‰å¯ç”¨ä½æ ‡è®°
- å¯ç”¨/ç¦ç”¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªé¢å¤–çš„â€œä½ä¿¡æ¯â€ â†’ æ‰€ä»¥ä½ è¦æ˜¾å¼å£°æ˜ `IEnableableComponent` æ¥å£

**å®ƒå’Œ Add/Remove æœ‰å•¥åŒºåˆ«ï¼Ÿ**

| é¡¹ç›®                 | `Add/RemoveComponent`    | `EnableableComponent`  |
| -------------------- | ------------------------ | ---------------------- |
| æ˜¯å¦æ”¹å˜ Archetypeï¼Ÿ | âœ… ä¼šï¼ˆå¯¼è‡´ Chunk ç§»åŠ¨ï¼‰  | âŒ ä¸ä¼š                 |
| æ˜¯å¦æ¸…ç©ºæ•°æ®ï¼Ÿ       | âœ… Remove ä¼šåˆ å…‰          | âŒ Disable åªæ˜¯ä¸´æ—¶å¤±æ•ˆ |
| èƒ½å¦è½»æ¾å¼€å…³ï¼Ÿ       | âŒ æœ‰ GC & Chunk ç®¡ç†å¼€é”€ | âœ… éå¸¸å¿«ï¼Œä½çº§æ“ä½œ     |
| èƒ½å¦ä¿å­˜åŸå§‹çŠ¶æ€ï¼Ÿ   | âŒ Remove ä¼šä¸¢æ•°æ®        | âœ… Enable åä»ä¿ç•™æ•°æ®  |
| æ˜¯å¦é€‚åˆé¢‘ç¹åˆ‡æ¢ï¼Ÿ   | âŒ ä¸é€‚åˆ                 | âœ… éå¸¸é€‚åˆ             |

## å­˜å‚¨åŸç†

Enableable Component å…¶å®æ˜¯ï¼š
åœ¨ Chunk çš„å…ƒæ•°æ®ä¸­ä¸ºæ¯ä¸ªå¯ç”¨äº† `IEnableableComponent` çš„ç±»å‹ï¼Œ**æ·»åŠ ä¸€ç»„ä½æ©ç ï¼ˆBitFieldï¼‰**

æ¯ä¸ª Chunk ä¼šæœ‰ä¸€ä¸ªç±»ä¼¼ï¼š

```
BitField for Movement: 10101010101...
```

æ¯ä¸ªä½è¡¨ç¤ºå¯¹åº”å®ä½“æ˜¯å¦å¯ç”¨ã€‚

æŸ¥è¯¢ç³»ç»Ÿå¯ä»¥ç”¨ä½æ“ä½œè¿‡æ»¤ï¼Œæ— éœ€ç§»åŠ¨ Chunkï¼

## ä½¿ç”¨æ–¹æ³•

ä½ å¯ä»¥è¿™æ ·å¯ç”¨æˆ–ç¦ç”¨ï¼š

```c#
// å¯ç”¨
EntityManager.SetComponentEnabled<Movement>(entity, true);

// ç¦ç”¨
EntityManager.SetComponentEnabled<Movement>(entity, false);
```

å¦‚ä½•åªæŸ¥è¯¢å¯ç”¨çš„ç»„ä»¶ï¼Ÿ

```c#
Entities
  .WithAll<Movement>() // åªåŒ…å«å¯ç”¨çŠ¶æ€çš„ Movement
  .ForEach((Entity e, ref Movement m) => {
      // è¿™é‡Œçš„ m æ˜¯å¯ç”¨çŠ¶æ€
  }).Schedule();
```

ä½ ä¹Ÿå¯ä»¥åè¿‡æ¥æ‰¾â€œç¦ç”¨çŠ¶æ€â€çš„ï¼š

```c#
Entities
  .WithDisabled<Movement>() // æ‰¾åˆ° Movement è¢« Disable çš„å®ä½“
```

**åº”ç”¨åœºæ™¯å¤§åˆé›† ğŸ’¡**

| åœºæ™¯                        | ç”¨æ³•                                        |
| --------------------------- | ------------------------------------------- |
| æš‚æ—¶å…³é—­ç§»åŠ¨è¡Œä¸º            | Disable `Movement` ç»„ä»¶                     |
| åŠ¨ç”»çŠ¶æ€åˆ‡æ¢ï¼ˆæ’­æ”¾ / åœæ­¢ï¼‰ | Enable / Disable `AnimationPlayback`        |
| å†·å´çŠ¶æ€ï¼ˆæŠ€èƒ½å¤±æ•ˆæ—¶ï¼‰      | Disable `AbilityReady`                      |
| èº²é¿ AI æ£€æµ‹ï¼ˆæ½œè¡Œæ—¶ï¼‰      | Disable `Targetable`                        |
| å»¶è¿Ÿæ¿€æ´»ç‰©ä½“                | å…ˆåŠ ç»„ä»¶ä½†è®¾ç½®ä¸º Disableï¼Œç­‰æ—¶æœºåˆ°äº† Enable |

**âš æ³¨æ„äº‹é¡¹**

| é—®é¢˜                              | æ˜¯å¦                                           |
| --------------------------------- | ---------------------------------------------- |
| æ‰€æœ‰ç»„ä»¶éƒ½èƒ½å¯ç”¨/ç¦ç”¨å—ï¼Ÿ         | âŒ åªæœ‰å®ç°äº† `IEnableableComponent` çš„ç»„ä»¶æ‰è¡Œ |
| Enable åèƒ½æ¢å¤åŸå€¼å—ï¼Ÿ           | âœ… å®Œå…¨ä¿ç•™ä¹‹å‰çš„æ•°æ®                           |
| Burst æ”¯æŒå—ï¼Ÿ                    | âœ… æ”¯æŒï¼Œä½æ©ç åˆ¤å®šéå¸¸é«˜æ•ˆ                     |
| æ”¯æŒå¤šä¸ª EnableableComponent å—ï¼Ÿ | âœ… å¯ä»¥å¤šä¸ªç»„ä»¶å„è‡ªæ§åˆ¶å¯ç”¨çŠ¶æ€                 |
| ä¼šå½±å“ Chunk åˆ†ç»„å—ï¼Ÿ             | âŒ ä¸ä¼šï¼Œå®Œå…¨é›¶æ‹·è´ã€æ— è¿ç§»                     |

æ€»ç»“ä¸€å¥è¯ï¼š
EnableableComponent = â€œçŠ¶æ€å¼€å…³ + æ— æ€§èƒ½æŸè€— + æ•°æ®ä¸ä¸¢å¤± + é›¶å†…å­˜ç§»åŠ¨â€çš„è¡Œä¸ºæ§åˆ¶ç¥å™¨ã€‚

# 6. `IComponentData + Tag`ç©ºç»„ä»¶

åœ¨ DOTS çš„ `IComponentData` å®¶æ—ä¸­ï¼Œè¿˜æœ‰ä¸€ç±» **æä¸ºå¸¸ç”¨ä½†å®¹æ˜“è¢«å¿½ç•¥çš„**ç±»å‹ï¼Œé‚£å°±æ˜¯ï¼šIComponentData + ç©ºç»“æ„ä½“ï¼ˆTag ç»„ä»¶ï¼‰ã€‚

Tag Component æ˜¯ä¸€ç§â€œæ— å­—æ®µâ€çš„ç»„ä»¶ï¼Œç”¨æ¥ç»™ Entity æ‰“æ ‡ç­¾ã€åšé€»è¾‘åˆ†ç±»ã€æ¡ä»¶æŸ¥è¯¢ã€‚

å®ƒçš„ç»“æ„é€šå¸¸é•¿è¿™æ ·ï¼š

```c#
public struct SleepingTag : IComponentData { }
```

å®ƒæ²¡æœ‰ä»»ä½•å­—æ®µï¼Œä¹Ÿä¸å­˜å‚¨æ•°æ®ï¼å°±åƒä½ åœ¨ GameObject é‡ŒåŠ ä¸ªç©ºçš„è„šæœ¬ï¼Œåªæ˜¯ä¸ºäº†è¯´ï¼šâ€œè¿™ä¸ªå¯¹è±¡è¢«æ‰“ä¸ŠæŸç§è¡Œä¸ºæ ‡ç­¾â€

ä¾‹å¦‚ï¼š

| ç»„ä»¶                   | æ„ä¹‰                       |
| ---------------------- | -------------------------- |
| `SleepingTag`          | è¿™ä¸ªå®ä½“ç›®å‰å¤„äºâ€œä¼‘çœ çŠ¶æ€â€ |
| `DeadTag`              | è¿™ä¸ªæ•Œäººå·²ç»æ­»äº¡           |
| `MarkedForDestruction` | ç³»ç»Ÿç¨åä¼šæ¸…é™¤è¿™ä¸ªå®ä½“     |

ä½ ä¸éœ€è¦ä¸€ä¸ª bool å­—æ®µã€ä¹Ÿä¸éœ€è¦æšä¸¾ï¼Œåªç”¨è¿™ä¸ªâ€œç©ºç»„ä»¶â€å°±å¯ä»¥å®ŒæˆçŠ¶æ€åˆ¤æ–­ã€‚

**ä¸ºä»€ä¹ˆä¸ç”¨ bool å­—æ®µæ¥åˆ¤æ–­ï¼Ÿ**

| é¡¹ç›®                      | `bool IsSleeping`           | `SleepingTag`                    |
| ------------------------- | --------------------------- | -------------------------------- |
| æ˜¯å¦éœ€è¦å†™å€¼ï¼Ÿ            | âœ… éœ€è¦                      | âŒ ä¸éœ€è¦                         |
| æ˜¯å¦ä¿®æ”¹ç»„ä»¶æ•°æ®ï¼Ÿ        | âœ… ä¼šè§¦å‘ ChangeVersion æ›´æ–° | âŒ ä¸ä¼šè§¦å‘ä»»ä½•ä¿®æ”¹               |
| æ˜¯å¦æ”¹å˜å†…å­˜å¸ƒå±€ï¼Ÿ        | âœ… æœ‰å­—æ®µå¤§å°                | âŒ Chunk å†…ä¸å ä»»ä½•ç©ºé—´ï¼ˆç©ºåˆ—ï¼‰   |
| æ˜¯å¦æ›´é€‚åˆ ECS æŸ¥è¯¢é€»è¾‘ï¼Ÿ | ä¸€èˆ¬                        | âœ… å®Œå…¨åŒ¹é… ECS çš„ Archetype æ¨¡å‹ |

Tag ç»„ä»¶åªæ”¹å˜ Archetypeï¼ˆæ·»åŠ æˆ–ç§»é™¤æ—¶ï¼‰ï¼Œ**å¯¹ Chunk å†…éƒ¨æ²¡æœ‰ä»»ä½•å­˜å‚¨æˆæœ¬ã€‚**

**Tag ç»„ä»¶çš„ä¼˜ç¼ºç‚¹æ€»ç»“ï¼š**

**ä¼˜ç‚¹:**

- é›¶å†…å­˜å¼€é”€
  ç©º struct ä¸å  Chunk ç©ºé—´
- æŸ¥è¯¢å‹å¥½
  å¯ä»¥ç›´æ¥ `.WithAll<T>()`ã€`.WithNone<T>()`
- ä¸éœ€è¦æ”¹ç»“æ„ä½“å­—æ®µ
  çŠ¶æ€åˆ‡æ¢åªéœ€ Add/Remove ç»„ä»¶å³å¯
- æ˜“è¯»æ€§é«˜
  æ¯” bool æ›´è¯­ä¹‰åŒ–ï¼ˆå¦‚ `DeadTag`ï¼‰

**ç¼ºç‚¹ï¼š**

- Add/Remove ä»ç„¶ä¼šæ”¹å˜ Archetypeï¼ˆå¯èƒ½å¼•å‘ Chunk ç§»åŠ¨ï¼‰
- ä¸é€‚åˆé¢‘ç¹åˆ‡æ¢
  æ¯” EnableableComponent å¼€é”€ç•¥é«˜ï¼ˆéœ€çœ‹ä½¿ç”¨é¢‘ç‡ï¼‰

 **Tag Componentï¼ŒEnableableComponentï¼ŒSharedComponentä¸‰è€…å¯¹æ¯”è¡¨**

| ç‰¹æ€§ / ç±»å‹             | Tag Component     | SharedComponent   | Enableable Component |
| ----------------------- | ----------------- | ----------------- | -------------------- |
| æ•°æ®å†…å®¹                | âŒ æ— å­—æ®µ          | âœ… æœ‰å€¼            | âœ… æœ‰å­—æ®µ             |
| åˆ†ç»„ä¾æ®                | æ˜¯å¦æœ‰ç»„ä»¶        | ç»„ä»¶å€¼            | å¯ç”¨/ç¦ç”¨æ ‡è®°        |
| æ˜¯å¦å‚ä¸ Chunk åˆ†ç»„     | âœ… æ˜¯ï¼ˆArchetypeï¼‰ | âœ… æ˜¯ï¼ˆChunkï¼‰     | âŒ å¦ï¼ˆåœ¨ä½å›¾ä¸­ï¼‰     |
| æ˜¯å¦å‚ä¸ Archetype å˜åŒ– | âœ… æ˜¯              | âŒ å¦              | âŒ å¦                 |
| æ˜¯å¦é€‚åˆé¢‘ç¹åˆ‡æ¢        | âŒ ä¸å»ºè®®          | âŒ ä¸å»ºè®®          | âœ… éå¸¸é€‚åˆ           |
| Job å¯è¯»å†™              | âœ… å®Œå…¨æ”¯æŒ        | âŒ ä¸æ”¯æŒ Job è¯»å€¼ | âœ… æ”¯æŒ               |

**å®æˆ˜åº”ç”¨å»ºè®®ï¼š**

| åœºæ™¯                               | æ¨è                                            |
| ---------------------------------- | ----------------------------------------------- |
| AI è¡Œä¸ºåˆ‡æ¢ï¼š`Sleeping` / `Active` | âœ… ç”¨ `EnableableComponent` æˆ– Tag               |
| é˜µè¥åˆ†ç»„ï¼šTeamID                   | âœ… ç”¨ `SharedComponent`                          |
| æ­»äº¡çŠ¶æ€ï¼šDead                     | âœ… ç”¨ `DeadTag`ï¼ˆTagï¼‰æˆ– `Enableable<Health>`    |
| åœ°å›¾åˆ†åŒºï¼šRegionID                 | âœ… ç”¨ `SharedComponent`                          |
| æŠ€èƒ½å†·å´ä¸­                         | âœ… ç”¨ Enableableï¼ˆå¯/ç¦ï¼‰ æˆ– CooldownTagï¼ˆè½»é‡ï¼‰ |

**æ€»ç»“ä¸€ä¸‹ã€Œç”¨è°æ›´åˆé€‚ï¼Ÿã€**

| éœ€æ±‚ç±»å‹                                | æ¨è                                        |
| --------------------------------------- | ------------------------------------------- |
| âœ”ï¸ ä½ åªéœ€è¦ä¸€ä¸ªâ€œæ˜¯å¦æœ‰â€æ ‡ç­¾              | ç”¨ Tag Componentï¼ˆæ›´è½»ã€æ›´å¿«ï¼‰              |
| âœ”ï¸ ä½ éœ€è¦åˆ†æˆå¤šä¸ªç»„ï¼ˆTeamID / RegionIDï¼‰ | ç”¨ SharedComponentData                      |
| âœ”ï¸ ä½ å¸Œæœ›ä½é¢‘åˆ‡æ¢çŠ¶æ€                    | éƒ½å¯ä»¥                                      |
| â— é«˜é¢‘çŠ¶æ€å˜åŒ–                          | ä¼˜å…ˆè€ƒè™‘ EnableableComponentï¼ˆæ›´é«˜æ€§èƒ½ï¼‰    |
| âŒ ä½ éœ€è¦åœ¨ Job ä¸­è¯»å–å€¼                 | Tag âœ…ï¼ŒShared âŒï¼ˆShared ä¸èƒ½ç”¨äº Job å‚æ•°ï¼‰ |

## ç”¨æ³•

ä½ å¯ä»¥é€šè¿‡æ˜¯å¦æ‹¥æœ‰è¯¥ç»„ä»¶ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ‰§è¡Œé€»è¾‘ï¼š

```c#
Entities
  .WithAll<SleepingTag>()  // åªå¤„ç†è¢«æ ‡è®°ä¸º Sleeping çš„å®ä½“
  .ForEach((Entity e, ref Translation t) => { ... })
  .Schedule();
```



